<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - College Red Cross Youth Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove, update, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    // Firebase config - same as your main index.html
    const firebaseConfig = {
      apiKey: "AIzaSyAlZLthDWmMioKQkznMKSOVQ7ggq8HYFfw",
      authDomain: "school-projects-c1354.firebaseapp.com",
      databaseURL: "https://school-projects-c1354-default-rtdb.firebaseio.com",
      projectId: "school-projects-c1354",
      storageBucket: "school-projects-c1354.appspot.com",
      messagingSenderId: "965342267950",
      appId: "1:965342267950:web:62527018cd97e4c5266dbf",
      measurementId: "G-7DQ3Q87FD0"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM references
    const eventsList = document.getElementById('eventsList');
    const eventTitleInput = document.getElementById('eventTitleInput');
    const addEventBtn = document.getElementById('addEventBtn');
    const exportBtn = document.getElementById('exportBtn');
    const filterInput = document.getElementById('filterInput');
    const entriesTable = document.getElementById('entriesTable');
    const entriesTbody = document.getElementById('entriesTbody');
    let selectedEventId = null;
    let allEvents = {};
    let allEntries = {};

    // Utils
    function renderEventsList() {
      eventsList.innerHTML = "";
      Object.entries(allEvents).forEach(([eventId, event]) => {
        const li = document.createElement('li');
        li.className = 'event-item' + (eventId === selectedEventId ? ' selected' : '');
        li.innerHTML = `
          <span class="event-title">${event.title || '[No Title]'}</span>
          <span class="event-status ${event.status === 'open' ? 'open' : 'closed'}">${event.status === 'open' ? 'Open' : 'Closed'}</span>
          <button class="toggle-status-btn">${event.status === 'open' ? 'Close' : 'Open'}</button>
          <button class="edit-event-btn">‚úèÔ∏è</button>
          <button class="delete-event-btn">üóëÔ∏è</button>
        `;
        // Select event on click (not on button click)
        li.addEventListener('click', (e) => {
          if (!['BUTTON', 'svg', 'path'].includes(e.target.tagName)) {
            selectEvent(eventId);
          }
        });
        // Toggle event status
        li.querySelector('.toggle-status-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          const newStatus = (event.status === 'open' ? 'closed' : 'open');
          update(ref(db, `events/${eventId}`), { status: newStatus });
        });
        // Edit event
        li.querySelector('.edit-event-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          const newTitle = prompt("Edit event title:", event.title || "");
          if (newTitle !== null && newTitle.trim()) {
            update(ref(db, `events/${eventId}`), { title: newTitle.trim() });
          }
        });
        // Delete event
        li.querySelector('.delete-event-btn').addEventListener('click', async (e) => {
          e.stopPropagation();
          if (confirm("Delete this event and all its attendance entries?")) {
            await remove(ref(db, `events/${eventId}`));
            await remove(ref(db, `attendance/${eventId}`));
            if (selectedEventId === eventId) selectEvent(null);
          }
        });
        eventsList.appendChild(li);
      });
    }

    function selectEvent(eventId) {
      selectedEventId = eventId;
      renderEventsList();
      loadEntries();
      document.getElementById('currentEventTitle').textContent =
        eventId && allEvents[eventId] ? allEvents[eventId].title : 'No Event Selected';
      exportBtn.style.display = selectedEventId ? 'inline-block' : 'none';
    }

    // Add new event
    addEventBtn.addEventListener('click', async () => {
      const title = eventTitleInput.value.trim();
      if (!title) return alert("Please enter an event title.");
      const eventRef = push(ref(db, 'events'));
      await set(eventRef, {
        title: title,
        status: 'open',
        createdAt: new Date().toISOString()
      });
      eventTitleInput.value = '';
      selectEvent(eventRef.key);
    });

    // Listen for events
    onValue(ref(db, 'events'), (snapshot) => {
      allEvents = snapshot.val() || {};
      renderEventsList();
      // If no event selected, pick the latest one (by createdAt)
      if (!selectedEventId && Object.keys(allEvents).length) {
        const latest = Object.entries(allEvents)
          .sort((a, b) => (b[1].createdAt || '').localeCompare(a[1].createdAt || ''))[0][0];
        selectEvent(latest);
      }
      // update index.html event title via localStorage
      if (Object.keys(allEvents).length) {
        const latestEvent = Object.entries(allEvents)
          .sort((a, b) => (b[1].createdAt || '').localeCompare(a[1].createdAt || ''))[0][1];
        localStorage.setItem('latestEventTitle', latestEvent.title || '');
      }
    });

    // Load attendance entries for selected event
    function loadEntries() {
      if (!selectedEventId) {
        entriesTbody.innerHTML = "";
        allEntries = {};
        return;
      }
      onValue(ref(db, `attendance/${selectedEventId}`), (snapshot) => {
        allEntries = snapshot.val() || {};
        renderEntries();
      });
    }

    // Render attendance entries table
    function renderEntries(filter = "") {
      entriesTbody.innerHTML = "";
      let filtered = Object.entries(allEntries);
      if (filter) {
        const f = filter.toLowerCase();
        filtered = filtered.filter(([k, entry]) =>
          Object.values(entry).join(" ").toLowerCase().includes(f)
        );
      }
      filtered.forEach(([entryId, entry]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${entry.name}</td>
          <td>${entry.email}</td>
          <td>${entry.department}</td>
          <td>${entry.yearLevel}</td>
          <td>${entry.section}</td>
          <td>${entry.strand || ''}</td>
          <td>${entry.program || ''}</td>
          <td>${entry.timestamp ? new Date(entry.timestamp).toLocaleString() : ''}</td>
          <td>
            <button class="edit-entry-btn">‚úèÔ∏è</button>
            <button class="delete-entry-btn">üóëÔ∏è</button>
          </td>
        `;
        // Edit
        tr.querySelector('.edit-entry-btn').addEventListener('click', () => {
          const newName = prompt("Edit name:", entry.name);
          if (newName !== null && newName.trim()) {
            update(ref(db, `attendance/${selectedEventId}/${entryId}`), { name: newName.trim() });
          }
        });
        // Delete
        tr.querySelector('.delete-entry-btn').addEventListener('click', async () => {
          if (confirm("Delete this entry?")) {
            await remove(ref(db, `attendance/${selectedEventId}/${entryId}`));
          }
        });
        entriesTbody.appendChild(tr);
      });
    }

    // Filter
    filterInput.addEventListener('input', () => {
      renderEntries(filterInput.value);
    });

    // Export
    exportBtn.addEventListener('click', () => {
      const rows = [["Name", "Email", "Department", "Year Level", "Section", "Strand", "Program", "Timestamp"]];
      Object.values(allEntries).forEach(entry => {
        rows.push([
          entry.name, entry.email, entry.department, entry.yearLevel,
          entry.section, entry.strand || '', entry.program || '', entry.timestamp || ''
        ]);
      });
      // CSV download
      const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = (allEvents[selectedEventId]?.title || "attendance") + ".csv";
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    });

    // Add entry manually
    document.getElementById('addEntryBtn').addEventListener('click', async () => {
      if (!selectedEventId) return alert("Please select an event.");
      const name = prompt("Name:");
      if (!name || !name.trim()) return;
      const email = prompt("Email:");
      if (!email || !email.trim()) return;
      // For brevity, fill other fields with empty/defaults; could expand to a modal or form
      await push(ref(db, `attendance/${selectedEventId}`), {
        name: name.trim(),
        email: email.trim(),
        department: "",
        yearLevel: "",
        section: "",
        strand: "",
        program: "",
        timestamp: new Date().toISOString()
      });
    });

    // Initial UI state
    exportBtn.style.display = 'none';
    document.getElementById('currentEventTitle').textContent = 'No Event Selected';
  </script>
  <style>
    body { background: #f3f4f6; font-family: 'Segoe UI', Arial, sans-serif; }
    .admin-panel { max-width: 1200px; margin: 2rem auto; background: #fff; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 4px 24px 0 #0002; }
    .admin-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; }
    .event-actions { display: flex; gap: 1rem; }
    .event-list { list-style: none; padding: 0; margin: 0 0 2rem 0; }
    .event-item { display: flex; align-items: center; gap: .8rem; padding: .5rem 1rem; border-radius: .6rem; background: #f7f9fa; margin-bottom: .3rem; cursor: pointer; }
    .event-item.selected { background: #e3f2fd; font-weight: bold; }
    .event-title { flex: 1; }
    .event-status.open { color: #43a047; font-weight: bold; }
    .event-status.closed { color: #e53935; font-weight: bold; }
    .event-item button { border: none; background: none; cursor: pointer; font-size: 1.1em; }
    .admin-tools { display: flex; align-items: center; gap: 1.2rem; margin-bottom: 1.5rem; }
    .admin-tools input[type="text"] { padding: .5rem 1rem; border: 1.5px solid #ccc; border-radius: .5rem; font-size: 1rem;}
    .admin-tools button { padding: .5rem 1.2rem; border: none; border-radius: .5rem; background: #1565c0; color: #fff; font-weight: bold; cursor: pointer; }
    .admin-tools button:hover { background: #0d47a1; }
    .entries-table { width: 100%; border-collapse: collapse; background: #fafbfc; }
    .entries-table th, .entries-table td { padding: .7rem 1rem; border-bottom: 1px solid #e3e3e3;}
    .entries-table th { background: #e3f2fd; }
    .entries-table td:last-child { text-align: center; }
    .entries-table button { background: none; border: none; cursor: pointer; font-size: 1.1em;}
    @media (max-width: 900px) {
      .admin-panel { padding: 1rem; }
      .admin-header { flex-direction: column; gap: 1rem; }
      .admin-tools { flex-direction: column; align-items: stretch; gap: .5rem;}
      .entries-table th, .entries-table td { padding: .5rem .5rem;}
    }
  </style>
</head>
<body>
  <div class="admin-panel">
    <div class="admin-header">
      <h1>Admin Panel - Attendance Events</h1>
      <div class="event-actions">
        <input type="text" id="eventTitleInput" placeholder="New Event Title" />
        <button id="addEventBtn">Add Event</button>
      </div>
    </div>
    <ul id="eventsList" class="event-list"></ul>
    <div class="admin-tools">
      <span><b>Current Event:</b> <span id="currentEventTitle"></span></span>
      <button id="addEntryBtn">Add Entry</button>
      <input type="text" id="filterInput" placeholder="Filter entries..." />
      <button id="exportBtn">Export CSV</button>
    </div>
    <div style="overflow-x:auto">
      <table class="entries-table" id="entriesTable">
        <thead>
          <tr>
            <th>Name</th><th>Email</th><th>Department</th><th>Year Level</th>
            <th>Section</th><th>Strand</th><th>Program</th><th>Timestamp</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="entriesTbody"></tbody>
      </table>
    </div>
  </div>
</body>
</html>